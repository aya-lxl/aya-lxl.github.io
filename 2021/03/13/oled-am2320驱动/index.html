<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"aya-lxl.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="0、说明在linux平台上，开发两个驱动：OLED与AM2320，在OLED上显示传感器的温湿度信息。">
<meta property="og:type" content="article">
<meta property="og:title" content="oled-am2320驱动">
<meta property="og:url" content="https://aya-lxl.github.io/2021/03/13/oled-am2320%E9%A9%B1%E5%8A%A8/index.html">
<meta property="og:site_name" content="直到海角天涯">
<meta property="og:description" content="0、说明在linux平台上，开发两个驱动：OLED与AM2320，在OLED上显示传感器的温湿度信息。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s3.ax1x.com/2021/02/10/y00mKP.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/02/10/y00iUe.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/02/10/y00MVS.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/13/6dEAYT.jpg">
<meta property="og:image" content="https://s3.ax1x.com/2021/02/10/y0088s.jpg">
<meta property="og:image" content="https://s3.ax1x.com/2021/02/10/y00NrV.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/13/6dEPwq.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/13/6dAyLR.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/13/6dAUoV.jpg">
<meta property="article:published_time" content="2021-03-13T02:17:47.000Z">
<meta property="article:modified_time" content="2021-03-24T01:32:28.685Z">
<meta property="article:author" content="aya_lxl@163.com">
<meta property="article:tag" content="驱动">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s3.ax1x.com/2021/02/10/y00mKP.png">

<link rel="canonical" href="https://aya-lxl.github.io/2021/03/13/oled-am2320%E9%A9%B1%E5%8A%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>oled-am2320驱动 | 直到海角天涯</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">直到海角天涯</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://aya-lxl.github.io/2021/03/13/oled-am2320%E9%A9%B1%E5%8A%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aya_lxl@163.com">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="直到海角天涯">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          oled-am2320驱动
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-13 10:17:47" itemprop="dateCreated datePublished" datetime="2021-03-13T10:17:47+08:00">2021-03-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-03-24 09:32:28" itemprop="dateModified" datetime="2021-03-24T09:32:28+08:00">2021-03-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h4 id="0、说明"><a href="#0、说明" class="headerlink" title="0、说明"></a>0、说明</h4><p>在linux平台上，开发两个驱动：OLED与AM2320，在OLED上显示传感器的温湿度信息。</p>
<p>开发板使用正点原子的i.MX6ULL Linux阿尔法开发板。</p>
<p><img src="https://s3.ax1x.com/2021/02/10/y00mKP.png" alt="y00mKP.png"></p>
<h4 id="1、OLED"><a href="#1、OLED" class="headerlink" title="1、OLED"></a>1、OLED</h4><p>OLED（OrganicLight-Emitting  Diode），又称为有机电激光显示、有机发光半导体（OrganicElectroluminesence  Display，OLED）。OLED属于一种电流型的有机发光器件，是通过载流子的注入和复合而致发光的现象，发光强度与注入的电流成正比【<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/OLED/1328114?fr=aladdin">百度百科</a>】。与LCD不同，OLED不需要背光。</p>
<p>OLED显示器依驱动方式的不同又可分为被动式（Passive Matrix，<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/w/index.php?title=PMOLED&action=edit&redlink=1">PMOLED</a>）与主动式（Active Matrix，<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/AMOLED">AMOLED</a>），具体可参考<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/25669200">https://www.zhihu.com/question/25669200</a>。</p>
<p>本文所使用的的OLED是0.96寸，如下图：</p>
<p><img src="https://s3.ax1x.com/2021/02/10/y00iUe.png" alt="y00iUe.png"></p>
<p>该显示屏可以选择IIC或者SPI的方式通信，这里使用SPI的方式，可以参考<a target="_blank" rel="noopener" href="https://wenku.baidu.com/view/42efcb877cd184254a353584">https://wenku.baidu.com/view/42efcb877cd184254a353584</a></p>
<h5 id="（1）引脚"><a href="#（1）引脚" class="headerlink" title="（1）引脚"></a>（1）引脚</h5><p>由于开发板接口的问题，OLED的驱动使用模拟SPI的方式，使用的引脚如设备树中的定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pinctrl_oled: oledgrp &#123;</span><br><span class="line">            fsl,pins &#x3D; &lt;</span><br><span class="line">				MX6UL_PAD_GPIO1_IO01__GPIO1_IO01	0x10B0</span><br><span class="line">				MX6UL_PAD_GPIO1_IO02__GPIO1_IO02	0x10B0</span><br><span class="line">				MX6UL_PAD_GPIO1_IO03__GPIO1_IO03	0x10B0</span><br><span class="line">				MX6UL_PAD_GPIO1_IO04__GPIO1_IO04	0x10B0</span><br><span class="line">            &gt;;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">	oled &#123;</span><br><span class="line">		#address-cells &#x3D; &lt;1&gt;;</span><br><span class="line">		#size-cells &#x3D; &lt;1&gt;;</span><br><span class="line">		compatible &#x3D; &quot;lxl-oled&quot;;</span><br><span class="line">		pinctrl-names &#x3D; &quot;default&quot;;</span><br><span class="line">		pinctrl-0 &#x3D; &lt;&amp;pinctrl_oled&gt;;</span><br><span class="line">		oled-gpio1 &#x3D; &lt;&amp;gpio1 1 GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">		oled-gpio2 &#x3D; &lt;&amp;gpio1 2 GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">		oled-gpio3 &#x3D; &lt;&amp;gpio1 3 GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">		oled-gpio4 &#x3D; &lt;&amp;gpio1 4 GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">		status &#x3D; &quot;okay&quot;;</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>
<p>当然，其它功能不应该再使用这几个引脚了。</p>
<h5 id="（2）OLED指令"><a href="#（2）OLED指令" class="headerlink" title="（2）OLED指令"></a>（2）OLED指令</h5><p>使用0.96寸OLED，操作命令如下图。</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/y00MVS"><img src="https://s3.ax1x.com/2021/02/10/y00MVS.png" alt="y00MVS.png"></a></p>
<h5 id="（3）图像显示"><a href="#（3）图像显示" class="headerlink" title="（3）图像显示"></a>（3）图像显示</h5><p>这里仅仅是作为一个展示，因为显示图片还需要做一些转换：将图像内容二值化（若彩色图片）后，按照OLED显示顺序来处理，重新组合为适合于OLED的数据格式。比如下面的二维码显示。</p>
<p><img src="https://s3.ax1x.com/2021/03/13/6dEAYT.jpg" alt="6dEAYT.jpg"></p>
<p>一个需要注意的问题，因为是OLED，如果某个点需要亮，那么将该点写1，否则就是暗的，所以二维码处理的时候还需要反转一下，即黑变为白，白变为黑，也就是如下图所示，经过点阵处理工具处理后，在OLED上显示正常的图像。上图就是反转之后在OLED上的显示图像。</p>
<p>但是，也发现一个有意思的现象，即微信支付宝均可以识别反转的图像。</p>
<p><img src="https://s3.ax1x.com/2021/02/10/y0088s.jpg" alt="y0088s.jpg"></p>
<h5 id="（4）驱动源码"><a href="#（4）驱动源码" class="headerlink" title="（4）驱动源码"></a>（4）驱动源码</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;oledfont.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE 					16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> XLEVEL_L				0x00</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> XLEVEL_H				0x10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_COLUMN				128</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_ROW					64</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	BRIGHTNESS				0xFF</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> X_WIDTH 				128</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Y_WIDTH 				64</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OLED_DATA 1				<span class="comment">//写数据</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OLED_CMD  0				<span class="comment">//写命令</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">oled0_switch</span><span class="params">(u8 bit, u8 sta)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OLED_RST_CLR() oled0_switch(3,0) <span class="comment">//RES RES =&gt; 接RES引脚</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OLED_RST_SET() oled0_switch(3,1)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OLED_DC_CLR() oled0_switch(4,0)	<span class="comment">//DC  DC  =&gt; 接DC引脚 </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OLED_DC_SET() oled0_switch(4,1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 使用4线串行接口时使用 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OLED_SCLK_CLR() oled0_switch(1,0)<span class="comment">//CLK D0  =&gt; 接D0引脚</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OLED_SCLK_SET() oled0_switch(1,1)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OLED_SDIN_CLR() oled0_switch(2,0)<span class="comment">//PIN D1  =&gt; 接D1引脚</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OLED_SDIN_SET() oled0_switch(2,1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @brief 写入一个字节</span></span><br><span class="line"><span class="comment"> * @param dat:要写入的数据/命令, cmd:0,表示命令;1,表示数据;</span></span><br><span class="line"><span class="comment"> * @retval None</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">oled_write_byte</span><span class="params">(<span class="keyword">uint8_t</span> dat, <span class="keyword">uint8_t</span> cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint8_t</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(cmd == OLED_DATA)</span><br><span class="line">        OLED_DC_SET();</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(cmd == OLED_CMD)</span><br><span class="line">        OLED_DC_CLR();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        OLED_SCLK_CLR();</span><br><span class="line">        <span class="keyword">if</span>(dat &amp; <span class="number">0x80</span>)</span><br><span class="line">            OLED_SDIN_SET();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            OLED_SDIN_CLR();</span><br><span class="line">        OLED_SCLK_SET();</span><br><span class="line">        dat &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    OLED_DC_SET();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @brief</span></span><br><span class="line"><span class="comment"> * @param </span></span><br><span class="line"><span class="comment"> * @retval None</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">oled_set_pos</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> x, <span class="keyword">unsigned</span> <span class="keyword">char</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    oled_write_byte(<span class="number">0xb0</span> + y, OLED_CMD);</span><br><span class="line">    oled_write_byte(((x &amp; <span class="number">0xf0</span>) &gt;&gt; <span class="number">4</span>) | <span class="number">0x10</span>, OLED_CMD);</span><br><span class="line">    oled_write_byte(x &amp; <span class="number">0x0f</span>, OLED_CMD);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @brief 开启OLED显示</span></span><br><span class="line"><span class="comment"> * @param None</span></span><br><span class="line"><span class="comment"> * @retval None</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">oled_display_on</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    oled_write_byte(<span class="number">0X8D</span>, OLED_CMD);</span><br><span class="line">    oled_write_byte(<span class="number">0X14</span>, OLED_CMD);</span><br><span class="line">    oled_write_byte(<span class="number">0XAF</span>, OLED_CMD);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @brief 关闭OLED显示</span></span><br><span class="line"><span class="comment"> * @param None</span></span><br><span class="line"><span class="comment"> * @retval None</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">oled_display_off</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    oled_write_byte(<span class="number">0X8D</span>, OLED_CMD);</span><br><span class="line">    oled_write_byte(<span class="number">0X10</span>, OLED_CMD);</span><br><span class="line">    oled_write_byte(<span class="number">0XAE</span>, OLED_CMD);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @brief 清屏函数,清完屏,整个屏幕是黑色的!和没点亮一样</span></span><br><span class="line"><span class="comment"> * @param None</span></span><br><span class="line"><span class="comment"> * @retval None</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">oled_clean</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint8_t</span> i, n;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        oled_write_byte(<span class="number">0xb0</span> + i, OLED_CMD);  <span class="comment">//设置页地址（0~7）</span></span><br><span class="line">        oled_write_byte(<span class="number">0x00</span>, OLED_CMD);      <span class="comment">//设置显示位置—列低地址</span></span><br><span class="line">        oled_write_byte(<span class="number">0x10</span>, OLED_CMD);      <span class="comment">//设置显示位置—列高地址</span></span><br><span class="line">        <span class="keyword">for</span>(n = <span class="number">0</span>; n &lt; <span class="number">128</span>; n++)</span><br><span class="line">            oled_write_byte(<span class="number">0</span>, OLED_DATA);</span><br><span class="line">    &#125;																	<span class="comment">//更新显示</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @brief 在指定位置显示一个字符,包括部分字符</span></span><br><span class="line"><span class="comment"> * @param x:0~127   y:0~63  chr:字符</span></span><br><span class="line"><span class="comment"> * @retval None</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">oled_show_char</span><span class="params">(<span class="keyword">uint8_t</span> x, <span class="keyword">uint8_t</span> y, <span class="keyword">uint8_t</span> chr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> c = <span class="number">0</span>, i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    c = chr - <span class="string">&#x27; &#x27;</span>;	<span class="comment">//得到偏移后的值</span></span><br><span class="line">    <span class="keyword">if</span>(x &gt; MAX_COLUMN - <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        x = <span class="number">0</span>;</span><br><span class="line">        y = y + <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(SIZE == <span class="number">16</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        oled_set_pos(x, y);</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">            oled_write_byte(D8X16[c * <span class="number">16</span> + i], OLED_DATA);</span><br><span class="line">        oled_set_pos(x, y + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">            oled_write_byte(D8X16[c * <span class="number">16</span> + i + <span class="number">8</span>], OLED_DATA);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        oled_set_pos(x, y + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            oled_write_byte(D6X8[c][i], OLED_DATA);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @brief m^n函数</span></span><br><span class="line"><span class="comment"> * @param </span></span><br><span class="line"><span class="comment"> * @retval None</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">oled_pow</span><span class="params">(<span class="keyword">uint8_t</span> m, <span class="keyword">uint8_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> result = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(n--)</span><br><span class="line">        result *= m;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @brief 显示2个数字</span></span><br><span class="line"><span class="comment"> * @param x,y :起点坐标</span></span><br><span class="line"><span class="comment"> * len :数字的位数，即显示几位有效数字</span></span><br><span class="line"><span class="comment"> * size:字体大小</span></span><br><span class="line"><span class="comment"> * num:数值(0~4294967295);</span></span><br><span class="line"><span class="comment"> * @retval None</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">oled_show_num</span><span class="params">(<span class="keyword">uint8_t</span> x, <span class="keyword">uint8_t</span> y, <span class="keyword">uint32_t</span> num, <span class="keyword">uint8_t</span> len, <span class="keyword">uint8_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint8_t</span> t, temp;</span><br><span class="line">    <span class="keyword">uint8_t</span> enshow = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(t = <span class="number">0</span>; t &lt; len; t++)</span><br><span class="line">    &#123;</span><br><span class="line">        temp = (num / oled_pow(<span class="number">10</span>, len - t - <span class="number">1</span>)) % <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">if</span>(enshow == <span class="number">0</span> &amp;&amp; t &lt; (len - <span class="number">1</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(temp == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                oled_show_char(x + (size / <span class="number">2</span>)*t, y, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> enshow = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        oled_show_char(x + (size / <span class="number">2</span>)*t, y, temp + <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @brief 显示一个字符号串</span></span><br><span class="line"><span class="comment"> * @param</span></span><br><span class="line"><span class="comment"> * @retval None</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">oled_show_string</span><span class="params">(<span class="keyword">uint8_t</span> x, <span class="keyword">uint8_t</span> y, <span class="keyword">char</span>* chr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> j = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(chr[j] != <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        oled_show_char(x, y, chr[j]);</span><br><span class="line">        x += <span class="number">8</span>;</span><br><span class="line">        <span class="keyword">if</span>(x &gt; <span class="number">120</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            x = <span class="number">0</span>;</span><br><span class="line">            y += <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        j++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @brief 显示汉字</span></span><br><span class="line"><span class="comment"> * @param</span></span><br><span class="line"><span class="comment"> * @retval None</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">oled_show_chinese</span><span class="params">(<span class="keyword">uint8_t</span> x, <span class="keyword">uint8_t</span> y, <span class="keyword">uint8_t</span> no)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint8_t</span> t, adder = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    oled_set_pos(x, y);</span><br><span class="line">    <span class="keyword">for</span>(t = <span class="number">0</span>; t &lt; <span class="number">32</span>; t++)</span><br><span class="line">    &#123;</span><br><span class="line">        oled_write_byte(SHOW[<span class="number">2</span> * no][t], OLED_DATA);</span><br><span class="line">        adder += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    oled_set_pos(x, y + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span>(t = <span class="number">0</span>; t &lt; <span class="number">32</span>; t++)</span><br><span class="line">    &#123;</span><br><span class="line">        oled_write_byte(SHOW[<span class="number">2</span> * no + <span class="number">1</span>][t], OLED_DATA);</span><br><span class="line">        adder += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @brief 显示显示图片</span></span><br><span class="line"><span class="comment"> * @param 显示显示BMP图片128×64起始点坐标(x,y),x的范围0～127，y为页的范围0～7</span></span><br><span class="line"><span class="comment"> * x1,y1:对角坐标点</span></span><br><span class="line"><span class="comment"> * @retval None</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">oled_show_pic</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> x0, <span class="keyword">unsigned</span> <span class="keyword">char</span> y0, <span class="keyword">unsigned</span> <span class="keyword">char</span> x1, <span class="keyword">unsigned</span> <span class="keyword">char</span> y1, <span class="keyword">unsigned</span> <span class="keyword">char</span> *pic)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> x, y;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(y = y0; y &lt; y1; y++)</span><br><span class="line">    &#123;</span><br><span class="line">        oled_set_pos(x0, y);</span><br><span class="line">        <span class="keyword">for</span>(x = x0; x &lt; x1; x++)</span><br><span class="line">        &#123;</span><br><span class="line">            oled_write_byte(pic[j++], OLED_DATA);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @brief 初始化SSD1306</span></span><br><span class="line"><span class="comment"> * @param None</span></span><br><span class="line"><span class="comment"> * @retval None</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">oled_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    OLED_RST_SET();</span><br><span class="line">    msleep(<span class="number">100</span>);</span><br><span class="line">    OLED_RST_CLR();</span><br><span class="line">    msleep(<span class="number">100</span>);</span><br><span class="line">    OLED_RST_SET();</span><br><span class="line"></span><br><span class="line">    oled_write_byte(<span class="number">0xAE</span>, OLED_CMD); <span class="comment">//--turn off oled panel</span></span><br><span class="line">    oled_write_byte(<span class="number">0x00</span>, OLED_CMD); <span class="comment">//---set low column address</span></span><br><span class="line">    oled_write_byte(<span class="number">0x10</span>, OLED_CMD); <span class="comment">//---set high column address</span></span><br><span class="line">    oled_write_byte(<span class="number">0x40</span>, OLED_CMD); <span class="comment">//--set start line address  Set Mapping RAM Display Start Line (0x00~0x3F)</span></span><br><span class="line">    oled_write_byte(<span class="number">0x81</span>, OLED_CMD); <span class="comment">//--set contrast control register</span></span><br><span class="line">    oled_write_byte(<span class="number">0xCF</span>, OLED_CMD); <span class="comment">// Set SEG Output Current BRIGHTNESS</span></span><br><span class="line">    oled_write_byte(<span class="number">0xA1</span>, OLED_CMD); <span class="comment">//--Set SEG/Column Mapping     0xa0左右反置 0xa1正常</span></span><br><span class="line">    oled_write_byte(<span class="number">0xC8</span>, OLED_CMD); <span class="comment">//Set COM/Row Scan Direction   0xc0上下反置 0xc8正常</span></span><br><span class="line">    oled_write_byte(<span class="number">0xA6</span>, OLED_CMD); <span class="comment">//--set normal display</span></span><br><span class="line">    oled_write_byte(<span class="number">0xA8</span>, OLED_CMD); <span class="comment">//--set multiplex ratio(1 to 64)</span></span><br><span class="line">    oled_write_byte(<span class="number">0x3f</span>, OLED_CMD); <span class="comment">//--1/64 duty</span></span><br><span class="line">    oled_write_byte(<span class="number">0xD3</span>, OLED_CMD); <span class="comment">//-set display offset	Shift Mapping RAM Counter (0x00~0x3F)</span></span><br><span class="line">    oled_write_byte(<span class="number">0x00</span>, OLED_CMD); <span class="comment">//-not offset</span></span><br><span class="line">    oled_write_byte(<span class="number">0xd5</span>, OLED_CMD); <span class="comment">//--set display clock divide ratio/oscillator frequency</span></span><br><span class="line">    oled_write_byte(<span class="number">0x80</span>, OLED_CMD); <span class="comment">//--set divide ratio, Set Clock as 100 Frames/Sec</span></span><br><span class="line">    oled_write_byte(<span class="number">0xD9</span>, OLED_CMD); <span class="comment">//--set pre-charge period</span></span><br><span class="line">    oled_write_byte(<span class="number">0xF1</span>, OLED_CMD); <span class="comment">//Set Pre-Charge as 15 Clocks &amp; Discharge as 1 Clock</span></span><br><span class="line">    oled_write_byte(<span class="number">0xDA</span>, OLED_CMD); <span class="comment">//--set com pins hardware configuration</span></span><br><span class="line">    oled_write_byte(<span class="number">0x12</span>, OLED_CMD);</span><br><span class="line">    oled_write_byte(<span class="number">0xDB</span>, OLED_CMD); <span class="comment">//--set vcomh</span></span><br><span class="line">    oled_write_byte(<span class="number">0x40</span>, OLED_CMD); <span class="comment">//Set VCOM Deselect Level</span></span><br><span class="line">    oled_write_byte(<span class="number">0x20</span>, OLED_CMD); <span class="comment">//-Set Page Addressing Mode (0x00/0x01/0x02)</span></span><br><span class="line">    oled_write_byte(<span class="number">0x02</span>, OLED_CMD); <span class="comment">//</span></span><br><span class="line">    oled_write_byte(<span class="number">0x8D</span>, OLED_CMD); <span class="comment">//--set Charge Pump enable/disable</span></span><br><span class="line">    oled_write_byte(<span class="number">0x14</span>, OLED_CMD); <span class="comment">//--set(0x10) disable</span></span><br><span class="line">    oled_write_byte(<span class="number">0xA4</span>, OLED_CMD); <span class="comment">// Disable Entire Display On (0xa4/0xa5)</span></span><br><span class="line">    oled_write_byte(<span class="number">0xA6</span>, OLED_CMD); <span class="comment">// Disable Inverse Display On (0xa6/a7)</span></span><br><span class="line">    oled_write_byte(<span class="number">0xAF</span>, OLED_CMD); <span class="comment">//--turn on oled panel</span></span><br><span class="line"></span><br><span class="line">    oled_write_byte(<span class="number">0xAF</span>, OLED_CMD); <span class="comment">/*display ON*/</span></span><br><span class="line">    oled_clean();</span><br><span class="line">    oled_set_pos(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>头文件oledfont.h是字库、图形等的声明等，在这里无需过分关注。</p>
<p>上述代码是OLED的驱动，可以在单片机中使用，可参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/ningmeng484/p/10406590.html">https://www.cnblogs.com/ningmeng484/p/10406590.html</a>。因为这里是在linux系统上的驱动，所以需要做一些额外的工作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ide.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/of_gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/timer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/irq.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/mach/map.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OLEDDEV_CNT	    1	<span class="comment">/* 设备号长度 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OLEDDEV_NAME	<span class="meta-string">&quot;oled&quot;</span>	<span class="comment">/* 设备名字   */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OLEDOFF 	    0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OLEDON 		    1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* oleddev设备结构体 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">oleddev_dev</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">dev_t</span> devid;			<span class="comment">/* 设备号 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span>			<span class="comment">/* cdev */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span>* <span class="keyword">class</span>;</span>		<span class="comment">/* 类 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span>* <span class="title">device</span>;</span>		<span class="comment">/* 设备 */</span></span><br><span class="line">    <span class="keyword">int</span> major;				<span class="comment">/* 主设备号 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span>* <span class="title">node</span>;</span>		<span class="comment">/* OLED设备节点 */</span></span><br><span class="line">    <span class="keyword">int</span> oled1, oled2, oled3, oled4;	<span class="comment">/* OLED灯GPIO标号 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">oleddev_dev</span> <span class="title">oleddev</span>;</span> 		<span class="comment">/* oled设备 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description		: OLED控制引脚操作</span></span><br><span class="line"><span class="comment"> * @param	 	: bit,引脚；sta，状态</span></span><br><span class="line"><span class="comment"> * @return		: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">oled0_switch</span><span class="params">(u8 bit, u8 sta)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u8 pin;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(bit)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        pin = oleddev.oled1;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        pin = oleddev.oled2;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        pin = oleddev.oled3;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        pin = oleddev.oled4;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(sta == OLEDON)</span><br><span class="line">        gpio_set_value(bit, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(sta == OLEDOFF)</span><br><span class="line">        gpio_set_value(bit, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description		: 打开设备</span></span><br><span class="line"><span class="comment"> * @param - inode 	: 传递给驱动的inode</span></span><br><span class="line"><span class="comment"> * @param - filp 	: 设备文件，file结构体有个叫做private_data的成员变量</span></span><br><span class="line"><span class="comment"> * 			一般在open的时候将private_data指向设备结构体。</span></span><br><span class="line"><span class="comment"> * @return 		: 0 成功;其他 失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">oled_open</span><span class="params">(struct inode* inode, struct file* filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    filp-&gt;private_data = &amp;oleddev; <span class="comment">/* 设置私有数据  */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description		: 向设备写数据</span></span><br><span class="line"><span class="comment"> * @param - filp 	: 设备文件，表示打开的文件描述符</span></span><br><span class="line"><span class="comment"> * @param - buf 	: 要写给设备写入的数据</span></span><br><span class="line"><span class="comment"> * @param - cnt 	: 要写入的数据长度</span></span><br><span class="line"><span class="comment"> * @param - offt 	: 相对于文件首地址的偏移</span></span><br><span class="line"><span class="comment"> * @return		: 写入的字节数，如果为负值，表示写入失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">oled_write</span><span class="params">(struct file* filp, <span class="keyword">const</span> <span class="keyword">char</span> __user* buf, <span class="keyword">size_t</span> cnt, <span class="keyword">loff_t</span>* offt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retvalue;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> databuf[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">    retvalue = copy_from_user(databuf, buf, cnt);</span><br><span class="line">    <span class="keyword">if</span>(retvalue &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;kernel write faioled!\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    oled_clean();</span><br><span class="line">    oled_show_string(<span class="number">0</span>, <span class="number">1</span>, databuf);</span><br><span class="line">    <span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 设备操作函数 */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">oled_fops</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .open = oled_open,</span><br><span class="line">    .write = oled_write,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description		: flatform驱动的probe函数，当驱动与设备匹配以后此函数就会执行</span></span><br><span class="line"><span class="comment"> * @param - dev 	: platform设备</span></span><br><span class="line"><span class="comment"> * @return		: 0，成功;其他负值,失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">oled_probe</span><span class="params">(struct platform_device* dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">&quot;oled driver and device was matched!\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1、设置设备号 */</span></span><br><span class="line">    <span class="keyword">if</span>(oleddev.major)</span><br><span class="line">    &#123;</span><br><span class="line">        oleddev.devid = MKDEV(oleddev.major, <span class="number">0</span>);</span><br><span class="line">        register_chrdev_region(oleddev.devid, OLEDDEV_CNT, OLEDDEV_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        alloc_chrdev_region(&amp;oleddev.devid, <span class="number">0</span>, OLEDDEV_CNT, OLEDDEV_NAME);</span><br><span class="line">        oleddev.major = MAJOR(oleddev.devid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2、注册设备      */</span></span><br><span class="line">    cdev_init(&amp;oleddev.cdev, &amp;oled_fops);</span><br><span class="line">    cdev_add(&amp;oleddev.cdev, oleddev.devid, OLEDDEV_CNT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3、创建类      */</span></span><br><span class="line">    oleddev.class = class_create(THIS_MODULE, OLEDDEV_NAME);</span><br><span class="line">    <span class="keyword">if</span>(IS_ERR(oleddev.class))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(oleddev.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 4、创建设备 */</span></span><br><span class="line">    oleddev.device = device_create(oleddev.class, <span class="literal">NULL</span>, oleddev.devid, <span class="literal">NULL</span>, OLEDDEV_NAME);</span><br><span class="line">    <span class="keyword">if</span>(IS_ERR(oleddev.device))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(oleddev.device);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 5、初始化IO */</span></span><br><span class="line">    oleddev.node = of_find_node_by_path(<span class="string">&quot;/oled&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(oleddev.node == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;ooled node nost find!\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    oleddev.oled1 = of_get_named_gpio(oleddev.node, <span class="string">&quot;oled-gpio1&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(oleddev.oled1 &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;can&#x27;t get oled-gpio1\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    oleddev.oled2 = of_get_named_gpio(oleddev.node, <span class="string">&quot;oled-gpio2&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(oleddev.oled2 &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;can&#x27;t get oled-gpio2\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    oleddev.oled3 = of_get_named_gpio(oleddev.node, <span class="string">&quot;oled-gpio3&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(oleddev.oled3 &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;can&#x27;t get oled-gpio3\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    oleddev.oled4 = of_get_named_gpio(oleddev.node, <span class="string">&quot;oled-gpio4&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(oleddev.oled4 &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;can&#x27;t get oled-gpio4\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gpio_request(oleddev.oled1, <span class="string">&quot;oled-d0&quot;</span>);</span><br><span class="line">    gpio_direction_output(oleddev.oled1, <span class="number">1</span>);<span class="comment">/*d0 IO设置为输出，默认高电平*/</span></span><br><span class="line">    gpio_request(oleddev.oled2, <span class="string">&quot;oled-d1&quot;</span>);</span><br><span class="line">    gpio_direction_output(oleddev.oled2, <span class="number">1</span>);<span class="comment">/*d1 IO设置为输出，默认高电平*/</span></span><br><span class="line">    gpio_request(oleddev.oled3, <span class="string">&quot;oled-res&quot;</span>);</span><br><span class="line">    gpio_direction_output(oleddev.oled3, <span class="number">1</span>);<span class="comment">/*res IO设置为输出，默认高电平*/</span></span><br><span class="line">    gpio_request(oleddev.oled4, <span class="string">&quot;oled-dc&quot;</span>);</span><br><span class="line">    gpio_direction_output(oleddev.oled4, <span class="number">1</span>);<span class="comment">/*dc IO设置为输出，默认高电平*/</span></span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;ooled pin init ok\nstart to config ooled...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    oled_init();</span><br><span class="line">    oled_clean();</span><br><span class="line">    printk(<span class="string">&quot;showing...\n&quot;</span>);</span><br><span class="line">    <span class="comment">//oled_show_string(72, 0, &quot;hello&quot;);</span></span><br><span class="line">    <span class="comment">//oled_show_string(72, 6, &quot;hello&quot;);</span></span><br><span class="line"></span><br><span class="line">    oled_show_pic(<span class="number">0</span>,<span class="number">0</span>,<span class="number">64</span>,<span class="number">8</span>,(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)gImage_mail_er);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description	: platform驱动的remove函数，移除platform驱动的时候此函数会执行</span></span><br><span class="line"><span class="comment"> * @param - dev : platform设备</span></span><br><span class="line"><span class="comment"> * @return	: 0，成功;其它负值,失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">oled_remove</span><span class="params">(struct platform_device* dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    oled_clean();</span><br><span class="line"></span><br><span class="line">    gpio_set_value(oleddev.oled1, <span class="number">1</span>); 	<span class="comment">/* 卸载驱动的时候关闭OLED */</span></span><br><span class="line">    gpio_set_value(oleddev.oled2, <span class="number">1</span>);</span><br><span class="line">    gpio_set_value(oleddev.oled3, <span class="number">1</span>);</span><br><span class="line">    gpio_set_value(oleddev.oled4, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    cdev_del(&amp;oleddev.cdev);		<span class="comment">/*  删除cdev */</span></span><br><span class="line">    unregister_chrdev_region(oleddev.devid, OLEDDEV_CNT); <span class="comment">/* 注销设备号 */</span></span><br><span class="line">    device_destroy(oleddev.class, oleddev.devid);</span><br><span class="line">    class_destroy(oleddev.class);</span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 匹配列表 */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">oled_of_match</span>[] =</span></span><br><span class="line">&#123;</span><br><span class="line">    &#123; .compatible = <span class="string">&quot;lxl-oled&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="comment">/* Sentinel */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* platform驱动结构体 */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">oled_driver</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">    .driver		= &#123;</span><br><span class="line">        .name	= <span class="string">&quot;imx6ul-oled&quot;</span>,	<span class="comment">/* 驱动名字，用于和设备匹配 */</span></span><br><span class="line">        .of_match_table	= oled_of_match, <span class="comment">/* 设备树匹配表 		 */</span></span><br><span class="line">    &#125;,</span><br><span class="line">    .probe		= oled_probe,</span><br><span class="line">    .remove		= oled_remove,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description	: 驱动模块加载函数</span></span><br><span class="line"><span class="comment"> * @param 	: 无</span></span><br><span class="line"><span class="comment"> * @return	: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">oleddriver_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> platform_driver_register(&amp;oled_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description	: 驱动模块卸载函数</span></span><br><span class="line"><span class="comment"> * @param 	: 无</span></span><br><span class="line"><span class="comment"> * @return 	: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">oleddriver_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    platform_driver_unregister(&amp;oled_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(oleddriver_init);</span><br><span class="line">module_exit(oleddriver_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;lxl&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>驱动与设备树匹配（<code>lxl-oled</code>）成功后，会调用<code>oled_probe()</code>，进行设备的注册与创建，之后在设备树中查找<code>/oled</code>节点，获取模拟SPI的引脚并进行设置，最后初始化OLED。之后调用的<code>oled_show_pic()</code>函数是为了图片显示功能而调用的。</p>
<h4 id="2、AM2320"><a href="#2、AM2320" class="headerlink" title="2、AM2320"></a>2、AM2320</h4><h5 id="（1）简介"><a href="#（1）简介" class="headerlink" title="（1）简介"></a>（1）简介</h5><p>AM2320 数字温湿度传感器，是一款含有己校准数字信号输出的温湿度复合型传感器。传感器包括一个电容式感湿元件和一个高精度集成测温元件，并与一个高性能微处理器相连接。AM2320 通信方式有单总线、标准 I2C 两种通信方式。  </p>
<p>我们这里就是采用I2C的方式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&amp;iomuxc &#123;</span><br><span class="line">	pinctrl-names &#x3D; &quot;default&quot;;</span><br><span class="line">	imx6ul-evk &#123;</span><br><span class="line">		pinctrl_i2c2: i2c2grp &#123;</span><br><span class="line">			fsl,pins &#x3D; &lt;</span><br><span class="line">				MX6UL_PAD_UART5_TX_DATA__I2C2_SCL 0x4001b8b0</span><br><span class="line">				MX6UL_PAD_UART5_RX_DATA__I2C2_SDA 0x4001b8b0</span><br><span class="line">			&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;i2c2 &#123;</span><br><span class="line">	clock_frequency &#x3D; &lt;100000&gt;;</span><br><span class="line">	pinctrl-names &#x3D; &quot;default&quot;;</span><br><span class="line">	pinctrl-0 &#x3D; &lt;&amp;pinctrl_i2c2&gt;;</span><br><span class="line">	status &#x3D; &quot;okay&quot;;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;lxl:AM2320 5c</span><br><span class="line">	am2320@5c &#123;</span><br><span class="line">		compatible &#x3D; &quot;lxl,am2320&quot;;</span><br><span class="line">		reg &#x3D; &lt;0x5c&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>AM2320传感器的 I2C 的地址（SLAVE ADDRESS）为 0xB8，但是因为linux I2C在处理的时候，会将地址左移1位，所以在这里需要提前将地址右移1位，即0xB8变为0x5C，也就是上面设备树中am2320地址0x5c.</p>
<p>表 1：AM2320 数据寄存器表</p>
<table>
<thead>
<tr>
<th align="center">寄存器信息</th>
<th align="center">地址</th>
<th align="center">寄存器信息</th>
<th>地址</th>
<th align="center">寄存器信息</th>
<th align="center">地址</th>
<th align="center">寄存器信息</th>
<th align="center">地址</th>
</tr>
</thead>
<tbody><tr>
<td align="center">湿度高位</td>
<td align="center">0x00</td>
<td align="center">设备型号高位</td>
<td>0x08</td>
<td align="center">用户寄存器 1 高位</td>
<td align="center">0x10</td>
<td align="center">保留</td>
<td align="center">0x18</td>
</tr>
<tr>
<td align="center">湿度低位</td>
<td align="center">0x01</td>
<td align="center">设备型号低位</td>
<td>0x09</td>
<td align="center">用户寄存器 1 低位</td>
<td align="center">0x11</td>
<td align="center">保留</td>
<td align="center">0x19</td>
</tr>
<tr>
<td align="center">温度高位</td>
<td align="center">0x02</td>
<td align="center">版本号</td>
<td>0x0A</td>
<td align="center">用户寄存器 2 高位</td>
<td align="center">0x12</td>
<td align="center">保留</td>
<td align="center">0x1A</td>
</tr>
<tr>
<td align="center">温度低位</td>
<td align="center">0x03</td>
<td align="center">设备 ID(24-31) Bit</td>
<td>0x0B</td>
<td align="center">用户寄存器 2 低位</td>
<td align="center">0x13</td>
<td align="center">保留</td>
<td align="center">0x1B</td>
</tr>
<tr>
<td align="center">保留</td>
<td align="center">0x04</td>
<td align="center">设备 ID(16-23) Bit</td>
<td>0x0C</td>
<td align="center">保留</td>
<td align="center">0x14</td>
<td align="center">保留</td>
<td align="center">0x1C</td>
</tr>
<tr>
<td align="center">保留</td>
<td align="center">0x05</td>
<td align="center">设备 ID(8 - 15) Bit</td>
<td>0x0D</td>
<td align="center">保留</td>
<td align="center">0x15</td>
<td align="center">保留</td>
<td align="center">0x1D</td>
</tr>
<tr>
<td align="center">保留</td>
<td align="center">0x06</td>
<td align="center">设备 ID(0 - 7 ) Bit</td>
<td>0x0E</td>
<td align="center">保留</td>
<td align="center">0x16</td>
<td align="center">保留</td>
<td align="center">0x1E</td>
</tr>
<tr>
<td align="center">保留</td>
<td align="center">0x07</td>
<td align="center">状态寄存器</td>
<td>0x0F</td>
<td align="center">保留</td>
<td align="center">0x17</td>
<td align="center">保留</td>
<td align="center">0x1F</td>
</tr>
</tbody></table>
<p>读取数据的方式</p>
<p><img src="https://s3.ax1x.com/2021/02/10/y00NrV.png" alt="y00NrV.png"></p>
<h5 id="（2）驱动"><a href="#（2）驱动" class="headerlink" title="（2）驱动"></a>（2）驱动</h5><p>I.MX6U 的 I2C 适配器驱动 NXP 已经编写好了 ，这里直接使用即可，在总线驱动之上还有一个设备驱动，这是本驱动的重点。</p>
<p>AM2320的读写按照上面的说明操作即可。</p>
<h5 id="（3）源码"><a href="#（3）源码" class="headerlink" title="（3）源码"></a>（3）源码</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">2020-10-30 20:41</span></span><br><span class="line"><span class="comment">test ok</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ide.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/of_gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/timer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/i2c.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/mach/map.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> am2320_CNT 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> am2320_NAME <span class="meta-string">&quot;am2320&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">am2320_dev</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">dev_t</span> devid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">nd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> major;</span><br><span class="line">    <span class="keyword">void</span> *private_data;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> hum,tem;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HUM_H 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HUM_L 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TEM_H 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TEM_L 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">am2320_dev</span> <span class="title">am2320dev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">am2320_read_regs</span><span class="params">(struct am2320_dev *dev, u8 reg, <span class="keyword">void</span> *val, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msg</span>[2];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">client</span> =</span> (struct i2c_client *)dev-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    msg[<span class="number">0</span>].addr = client-&gt;addr;</span><br><span class="line">    msg[<span class="number">0</span>].flags = <span class="number">0</span>;</span><br><span class="line">    msg[<span class="number">0</span>].buf = &amp;reg;</span><br><span class="line">    msg[<span class="number">0</span>].len = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    msg[<span class="number">1</span>].addr = client-&gt;addr;</span><br><span class="line">    msg[<span class="number">1</span>].flags = I2C_M_RD;</span><br><span class="line">    msg[<span class="number">1</span>].buf = val;</span><br><span class="line">    msg[<span class="number">1</span>].len = len;</span><br><span class="line"></span><br><span class="line">    ret = i2c_transfer(client-&gt;adapter,msg, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ret = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;error @ %s,%d\n&quot;</span>,__func__,__LINE__);</span><br><span class="line">        printk(<span class="string">&quot;i2c rd failed =%d reg=%06d len=%d\n&quot;</span>, ret, reg, len);</span><br><span class="line">        ret = -EREMOTEIO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">am2320_read_regs_recv</span><span class="params">(struct am2320_dev *dev, <span class="keyword">void</span> *val, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msg</span>[2];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">client</span> =</span> (struct i2c_client *)dev-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    msg[<span class="number">0</span>].addr = client-&gt;addr;</span><br><span class="line">    msg[<span class="number">0</span>].flags = I2C_M_RD;</span><br><span class="line">    msg[<span class="number">0</span>].buf = val;</span><br><span class="line">    msg[<span class="number">0</span>].len = len;</span><br><span class="line"></span><br><span class="line">    ret = i2c_transfer(client-&gt;adapter,msg, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ret = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;error @ %s,%d\n&quot;</span>,__func__,__LINE__);</span><br><span class="line">        ret = -EREMOTEIO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> s32 <span class="title">am2320_write_regs</span><span class="params">(struct am2320_dev *dev, u8 reg, u8 *buf, u8 len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u8 b[<span class="number">256</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">client</span> =</span> (struct i2c_client *)dev-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    b[<span class="number">0</span>] = reg;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;b[<span class="number">1</span>], buf, len);</span><br><span class="line"></span><br><span class="line">    msg.addr = client-&gt;addr;</span><br><span class="line">    msg.flags = <span class="number">0</span>; <span class="comment">//write data</span></span><br><span class="line"></span><br><span class="line">    msg.buf = b;</span><br><span class="line">    msg.len = len + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> i2c_transfer(client-&gt;adapter, &amp;msg, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">am2320_readdata</span><span class="params">(struct am2320_dev *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//am2320_write_regs(dev,0,buf,0);//唤醒</span></span><br><span class="line"></span><br><span class="line">    buf[<span class="number">0</span>]=<span class="number">0</span>;</span><br><span class="line">    buf[<span class="number">1</span>]=<span class="number">4</span>;</span><br><span class="line">    am2320_write_regs(dev,<span class="number">0x03</span>,buf,<span class="number">2</span>);</span><br><span class="line">    mdelay(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">//am2320_read_regs(dev,0x03,buf,8);//lxl:!!!</span></span><br><span class="line">    <span class="keyword">if</span>(EREMOTEIO==am2320_read_regs_recv(dev,buf,<span class="number">8</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        dev-&gt;hum = <span class="number">0</span>;</span><br><span class="line">        dev-&gt;tem = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    dev-&gt;hum = (buf[<span class="number">2</span>]&lt;&lt;<span class="number">8</span>) + buf[<span class="number">3</span>];</span><br><span class="line">    dev-&gt;tem = (buf[<span class="number">4</span>]&lt;&lt;<span class="number">8</span>) + buf[<span class="number">5</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">am2320_open</span><span class="params">(struct inode *inode, struct file *filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    filp-&gt;private_data = &amp;am2320dev;</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>,__func__);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">am2320_read</span><span class="params">(struct file *filp, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> cnt, <span class="keyword">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">short</span> data[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">long</span> err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">am2320_dev</span> *<span class="title">dev</span> =</span> (struct am2320_dev *)filp-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//printk(&quot;%s,%d\n&quot;,__func__,__LINE__);</span></span><br><span class="line"></span><br><span class="line">    am2320_readdata(dev);</span><br><span class="line"></span><br><span class="line">    data[<span class="number">0</span>] = dev-&gt;hum;</span><br><span class="line">    data[<span class="number">1</span>] = dev-&gt;tem;</span><br><span class="line">    err = copy_to_user(buf, data, <span class="keyword">sizeof</span>(data));</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">am2320_release</span><span class="params">(struct inode *inode, struct file *filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>,__func__);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">am2320_ops</span> =</span> &#123;</span><br><span class="line">	.owner = THIS_MODULE,</span><br><span class="line">	.open = am2320_open,</span><br><span class="line">	.read = am2320_read,</span><br><span class="line">	.release = am2320_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">am2320_probe</span><span class="params">(struct i2c_client *client, <span class="keyword">const</span> struct i2c_device_id *id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>,__func__);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (am2320dev.major)</span><br><span class="line">    &#123;</span><br><span class="line">        am2320dev.devid = MKDEV(am2320dev.major, <span class="number">0</span>);</span><br><span class="line">        register_chrdev_region(am2320dev.devid, am2320_CNT, am2320_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        alloc_chrdev_region(&amp;am2320dev.devid, <span class="number">0</span>, am2320_CNT, am2320_NAME);</span><br><span class="line">        am2320dev.major = MAJOR(am2320dev.devid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cdev_init(&amp;am2320dev.cdev, &amp;am2320_ops);</span><br><span class="line">    cdev_add(&amp;am2320dev.cdev, am2320dev.devid, am2320_CNT);</span><br><span class="line"></span><br><span class="line">    am2320dev.class = class_create(THIS_MODULE, am2320_NAME);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(am2320dev.class))</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;%s,%d\n&quot;</span>,__func__,__LINE__);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(am2320dev.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    am2320dev.device = device_create(am2320dev.class, <span class="literal">NULL</span>, am2320dev.devid, <span class="literal">NULL</span>, am2320_NAME);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(am2320dev.device))</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;%s,%d\n&quot;</span>,__func__,__LINE__);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(am2320dev.device);</span><br><span class="line">    &#125;</span><br><span class="line">    am2320dev.private_data = client;</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;%s,%d\n&quot;</span>,__func__,__LINE__);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">am2320_remove</span><span class="params">(struct i2c_client *client)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cdev_del(&amp;am2320dev.cdev);</span><br><span class="line">    unregister_chrdev_region(am2320dev.devid, am2320_CNT);</span><br><span class="line"></span><br><span class="line">    device_destroy(am2320dev.class, am2320dev.devid);</span><br><span class="line">    class_destroy(am2320dev.class);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_device_id</span> <span class="title">am2320_id</span>[] =</span></span><br><span class="line">&#123;</span><br><span class="line">    &#123;<span class="string">&quot;lxl,am2320&quot;</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">am2320_of_match</span>[] =</span></span><br><span class="line">&#123;</span><br><span class="line">    &#123;.compatible = <span class="string">&quot;lxl,am2320&quot;</span>&#125;,</span><br><span class="line">    &#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span> <span class="title">am2320_driver</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">    .probe = am2320_probe,</span><br><span class="line">    .remove = am2320_remove,</span><br><span class="line">    .driver =</span><br><span class="line">    &#123;</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">        .name = <span class="string">&quot;lxl,am2320&quot;</span>,</span><br><span class="line">        .of_match_table = am2320_of_match,</span><br><span class="line">    &#125;,</span><br><span class="line">    .id_table = am2320_id,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">am2320_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;%s,%d\n&quot;</span>,__func__,__LINE__);</span><br><span class="line">    ret = i2c_add_driver(&amp;am2320_driver);</span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">0</span>)</span><br><span class="line">        printk(<span class="string">&quot;i2c_add_driver ok!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        printk(<span class="string">&quot;i2c_add_driver error!\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">am2320_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">&quot;%s\n&quot;</span>,__func__);</span><br><span class="line">    i2c_del_driver(&amp;am2320_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(am2320_init);</span><br><span class="line">module_exit(am2320_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;lXl&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>I2C 设备和驱动的匹配过程是由 I2C 核心（<code>drivers/i2c/i2c-core.c</code>）来完成的，设备和驱动的匹配过程也是由 I2C 总线完成的 。匹配成功后<code>am2320_probe</code>函数就会调用，在其中处理字符设备的那套东西。</p>
<h4 id="3、应用层"><a href="#3、应用层" class="headerlink" title="3、应用层"></a>3、应用层</h4><h5 id="（1）设备查看"><a href="#（1）设备查看" class="headerlink" title="（1）设备查看"></a>（1）设备查看</h5><p>加载am2320与OLED驱动</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ALIENTEK-IMX6U:~/nfs<span class="meta"># insmod oled.ko</span></span><br><span class="line">root@ALIENTEK-IMX6U:~/nfs<span class="meta"># insmod am2320.ko</span></span><br></pre></td></tr></table></figure>
<p>刚才安装的驱动可以在<code>/dev</code>下查看，如下图所示。</p>
<p><img src="https://s3.ax1x.com/2021/03/13/6dEPwq.png" alt="6dEPwq.png"></p>
<h5 id="（2）应用程序"><a href="#（2）应用程序" class="headerlink" title="（2）应用程序"></a>（2）应用程序</h5><p>驱动层只是将设备运行起来，具体如何使用这些设备，要看应用层。</p>
<p>可以对每个设备单独写应用程序，以便测试设备是否正常工作。下面的程序首先读取am2320传感器的数据，之后将数据写入OLED之中。原理很简单，直接看代码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;sys/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;sys/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;sys/ioctl.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;fcntl.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description		: main主程序</span></span><br><span class="line"><span class="comment"> * @param - argc	: argc数组元素个数</span></span><br><span class="line"><span class="comment"> * @param - argv	: 具体参数</span></span><br><span class="line"><span class="comment"> * @return		: 0 成功;其它 失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd_am2320,fd_oled;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> databuf[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> hum,tmp;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">time_t</span> t;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tm</span> *<span class="title">tmp_ptr</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> str[<span class="number">16</span>]=<span class="string">&quot;H:12.3, T:34.5&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    fd_am2320 = open(<span class="string">&quot;/dev/am2320&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd_am2320 &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t open file %s\r\n&quot;</span>, <span class="string">&quot;/dev/am2320&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    fd_oled = open(<span class="string">&quot;/dev/oled&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd_oled &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t open file %s\r\n&quot;</span>, <span class="string">&quot;/dev/oled&quot;</span>);</span><br><span class="line">        close(fd_am2320);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ret = read(fd_am2320, databuf, <span class="keyword">sizeof</span>(databuf));</span><br><span class="line">        <span class="keyword">if</span>(ret == <span class="number">0</span>) <span class="comment">/* 数据读取成功 */</span></span><br><span class="line">        &#123;</span><br><span class="line">            hum =  databuf[<span class="number">0</span>]; 	<span class="comment">/* 湿度 */</span></span><br><span class="line">            tmp = databuf[<span class="number">1</span>]; 	<span class="comment">/* 温度 */</span></span><br><span class="line">            <span class="built_in">snprintf</span>(str,<span class="number">15</span>,<span class="string">&quot;H:%2.1f, T:%2.1f&quot;</span>, <span class="number">1.0</span>*hum/<span class="number">10</span>,<span class="number">1.0</span>*tmp/<span class="number">10</span>);</span><br><span class="line">            </span><br><span class="line">            time (&amp;t);</span><br><span class="line">            tmp_ptr = localtime(&amp;t);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%02d:%02d:%02d --&gt; &quot;</span>, tmp_ptr-&gt;tm_hour, tmp_ptr-&gt;tm_min, tmp_ptr-&gt;tm_sec);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,str);<span class="comment">//lxl:!,&#x27;\n&#x27;</span></span><br><span class="line">            ret = write(fd_oled, str, <span class="number">15</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sleep(<span class="number">1</span>);<span class="comment">//usleep(1000000);</span></span><br><span class="line">    &#125;</span><br><span class="line">    close(fd_oled);</span><br><span class="line">    close(fd_am2320);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="（3）运行"><a href="#（3）运行" class="headerlink" title="（3）运行"></a>（3）运行</h5><p>上述两步成功后运行应用层APP</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ALIENTEK-IMX6U:~/nfs#./oledapp</span><br></pre></td></tr></table></figure>
<h5 id="（4）运行结果"><a href="#（4）运行结果" class="headerlink" title="（4）运行结果"></a>（4）运行结果</h5><ul>
<li><p>串口终端</p>
<p><img src="https://s3.ax1x.com/2021/03/13/6dAyLR.png" alt="6dAyLR.png"></p>
</li>
<li><p>OLED</p>
<p><img src="https://s3.ax1x.com/2021/03/13/6dAUoV.jpg" alt="6dAUoV.jpg"></p>
</li>
</ul>
<h4 id="4-、总结"><a href="#4-、总结" class="headerlink" title="4 、总结"></a>4 、总结</h4><p>本文中，使用GPIO模拟SPI来与OLED通信，使用linux之I2C总线与AM2320通信，在应用层读取传感器数据后写入OLED。</p>
<p>使用到了设备树、GPIO、linux I2C，同时在应用层编程，实现数据的获取与显示。</p>
<h4 id="5、主要参考"><a href="#5、主要参考" class="headerlink" title="5、主要参考"></a>5、主要参考</h4><p><a target="_blank" rel="noopener" href="http://www.openedv.com/docs/boards/arm-linux/zdyz-i.mx6ull.html">正点原子资料</a></p>
<p><a target="_blank" rel="noopener" href="https://wenku.baidu.com/view/42efcb877cd184254a353584">https://wenku.baidu.com/view/42efcb877cd184254a353584</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ningmeng484/p/10406590.html">https://www.cnblogs.com/ningmeng484/p/10406590.html</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E9%A9%B1%E5%8A%A8/" rel="tag"># 驱动</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/03/05/%E5%87%A0%E4%B8%AAlinux%E9%A2%98%E7%9B%AE/" rel="prev" title="几个linux测试题目">
      <i class="fa fa-chevron-left"></i> 几个linux测试题目
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/03/17/const%E5%AD%97%E7%AC%A6%E4%B8%B2/" rel="next" title="const字符串">
      const字符串 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#0%E3%80%81%E8%AF%B4%E6%98%8E"><span class="nav-number">1.</span> <span class="nav-text">0、说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81OLED"><span class="nav-number">2.</span> <span class="nav-text">1、OLED</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%BC%95%E8%84%9A"><span class="nav-number">2.1.</span> <span class="nav-text">（1）引脚</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%EF%BC%882%EF%BC%89OLED%E6%8C%87%E4%BB%A4"><span class="nav-number">2.2.</span> <span class="nav-text">（2）OLED指令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA"><span class="nav-number">2.3.</span> <span class="nav-text">（3）图像显示</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E9%A9%B1%E5%8A%A8%E6%BA%90%E7%A0%81"><span class="nav-number">2.4.</span> <span class="nav-text">（4）驱动源码</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81AM2320"><span class="nav-number">3.</span> <span class="nav-text">2、AM2320</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E7%AE%80%E4%BB%8B"><span class="nav-number">3.1.</span> <span class="nav-text">（1）简介</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E9%A9%B1%E5%8A%A8"><span class="nav-number">3.2.</span> <span class="nav-text">（2）驱动</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E6%BA%90%E7%A0%81"><span class="nav-number">3.3.</span> <span class="nav-text">（3）源码</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E5%BA%94%E7%94%A8%E5%B1%82"><span class="nav-number">4.</span> <span class="nav-text">3、应用层</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E8%AE%BE%E5%A4%87%E6%9F%A5%E7%9C%8B"><span class="nav-number">4.1.</span> <span class="nav-text">（1）设备查看</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="nav-number">4.2.</span> <span class="nav-text">（2）应用程序</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E8%BF%90%E8%A1%8C"><span class="nav-number">4.3.</span> <span class="nav-text">（3）运行</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="nav-number">4.4.</span> <span class="nav-text">（4）运行结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-number">5.</span> <span class="nav-text">4 、总结</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81%E4%B8%BB%E8%A6%81%E5%8F%82%E8%80%83"><span class="nav-number">6.</span> <span class="nav-text">5、主要参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">aya_lxl@163.com</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">24</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">aya_lxl@163.com</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
